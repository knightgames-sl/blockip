#!/bin/bash
#Backup previous list
rm BLACKLIST_OLD.txt
mv BLACKLIST.txt BLACKLIST_OLD.txt
touch BLACKLIST.txt
#Download the file from PGL.YOYO
curl -O http://pgl.yoyo.org/as/iplist.php
#Download the file from emerging threats
curl -O http://rules.emergingthreats.net/fwrules/emerging-Block-IPs.txt
#Download the first file from SpamHaus
curl -O http://www.spamhaus.org/drop/drop.txt
#Download the second file from SpamHaus
curl -O http://www.spamhaus.org/drop/edrop.txt
#Download the file from okean Korea
curl -O http://www.okean.com/sinokoreacidr.txt
#Download the file from okean China
curl -O http://www.okean.com/chinacidr.txt
#Download file from myip
curl -O http://www.myip.ms/files/blacklist/general/latest_blacklist.txt
#Download file from Blocklist.de
curl -O http://lists.blocklist.de/lists/all.txt
#Download bogon blacklist from cymru.org
curl -O http://www.team-cymru.org/Services/Bogons/fullbogons-ipv4.txt
#Download country blocks Russia China Afghanistan Iraq Iran HK India
curl -O http://www.ipdeny.com/ipblocks/data/countries/ru.zone
curl -O http://www.ipdeny.com/ipblocks/data/countries/cn.zone
curl -O http://www.ipdeny.com/ipblocks/data/countries/af.zone
curl -O http://www.ipdeny.com/ipblocks/data/countries/ir.zone
curl -O http://www.ipdeny.com/ipblocks/data/countries/iq.zone
curl -O http://www.ipdeny.com/ipblocks/data/countries/hk.zone
curl -O http://www.ipdeny.com/ipblocks/data/countries/in.zone
#Combine lists into one file
cat all.txt \
    drop.txt \
    edrop.txt \
    iplist.php \
    sinokoreacidr.txt \
    chinacidr.txt \
    latest_blacklist.txt \
    LocalBlacklist.txt \
    fullbogons-ipv4.txt \
    ru.zone \
    cn.zone \
    af.zone \
    ir.zone \
    iq.zone \
    hk.zone \
    in.zone \
    emerging-Block-IPs.txt > PreliminaryOutput.txt
#Strip out everything except for the IPV4 addresses
sed -e '/^#/ d' \
    -e '/[:\::]/ d' \
    -e 's/ .*// g' \
    -e 's/[^0-9,.,/]*// g' \
    -e '/^$/ d' < PreliminaryOutput.txt > PreUniqueOutput.txt
#Count the number of ip's    
sed -n '$=' PreUniqueOutput.txt
#Remove any duplicates
sort PreUniqueOutput.txt | uniq -u > BLACKLIST.txt
#Remove any preliminary files
rm Pre*
#Do a final count
sed -n '$=' BLACKLIST.txt
####
####
####
####trying to incorporate old list 
getnetblocks() {
cat <<EOF
# Generated by ipset
-N geotmp nethash --hashsize 1024 --probes 4 --resize 20
EOF
cat /config/blacklist/BLACKLIST.txt|egrep '^[0-9]'|egrep '/' |sed -e "s/^/-A geotmp /"
}
getnetblocks > /config/blacklist/netblock.txt
sudo ipset -! -R < /config/blacklist/netblock.txt
sudo ipset -W geotmp ET-N
sudo ipset -X geotmp

getaddblocks() {
cat <<EOF
# Generated by ipset
-N geotmp nethash --hashsize 1024 --probes 4 --resize 20
EOF
cat /config/blacklist/BLACKLIST.txt|egrep '^[0-9]'|egrep -v '/' |sed -e "s/^/-A geotmp /"
}
getaddblocks > /config/blacklist/addblock.txt
sudo ipset -! -R < /config/blacklist/addblock.txt
sudo ipset -W geotmp ET-A
sudo ipset -X geotmp

rm /config/blacklist/addblock.txt
rm /config/blacklist/netblock.txt
